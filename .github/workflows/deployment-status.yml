name: Deployment Status Workflow
on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Create deployment tracking issue
        uses: actions/github-script@v7
        id: create-issue
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              body: `Deployment of commit ${context.sha} started.`,
              labels: ['deployment', 'in-progress']
            });
            return issue.number;

      - name: Capture previous commit SHA
        id: previous-sha
        run: |
          PREVIOUS_SHA=$(git rev-parse HEAD^)
          echo "PREVIOUS_SHA=$PREVIOUS_SHA" >> $GITHUB_ENV

      - name: Capture package version
        id: package-version
        run: |
          PACKAGE_VERSION=$(npm pkg get version | sed 's/"//g')
          echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.number }},
              body: 'Pre-deployment checks completed'
            });

  rollback-preparation:
    needs: pre-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create rollback script
        run: |
          cat > rollback.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "Rollback script executed"
          EOF
          chmod +x rollback.sh

      - name: Create configuration backups
        run: |
          cp package.json package.json.bak
          cp package-lock.json package-lock.json.bak
          cp .env.template .env.template.bak

      - name: Create dependency verification script
        run: |
          cat > verify-dependencies.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "Verifying dependencies"
          EOF
          chmod +x verify-dependencies.sh

      - name: Create rollback documentation
        run: |
          cat > rollback-documentation.md << 'EOF'
          # Rollback Documentation

          ## Step-by-Step Instructions

          1. Run the rollback script
          2. Restore configuration backups
          3. Verify dependencies
          EOF

      - name: Create compressed rollback package
        run: |
          ZIP_FILE="rollback-package-${{ env.PREVIOUS_SHA }}.zip"
          zip -r $ZIP_FILE rollback.sh package.json.bak package-lock.json.bak .env.template.bak verify-dependencies.sh rollback-documentation.md
          SHA256=$(sha256sum $ZIP_FILE | awk '{print $1}')
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-artifacts
          path: |
            rollback.sh
            package.json.bak
            package-lock.json.bak
            .env.template.bak
            verify-dependencies.sh
            rollback-documentation.md
            ${{ env.ZIP_FILE }}
          retention-days: 30

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue-number }},
              body: 'ðŸ”„ Rollback Plan Ready\n\nPrevious Commit: ${{ env.PREVIOUS_SHA }}\nCurrent Commit: ${{ github.sha }}\nPackage Version: ${{ env.PACKAGE_VERSION }}\nArtifact: rollback-package-${{ env.PREVIOUS_SHA }}\n\nâœ… Rollback script created\nâœ… Configuration backup\nâœ… Dependency verification script\nâœ… Detailed rollback documentation\nâœ… Compressed rollback package\n\nQuick rollback command:\n```bash\nunzip rollback-package-${{ env.PREVIOUS_SHA }}.zip && chmod +x rollback.sh && ./rollback.sh\n```\n\nRollback script created: true\nConfiguration backup: true\nSHA256: ${{ env.SHA256 }}'
            });

  post-deployment:
    needs: rollback-preparation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update deployment issue labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.rollback-preparation.outputs.issue-number }},
              name: 'in-progress'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.rollback-preparation.outputs.issue-number }},
              labels: ['completed']
            });

      - name: Post final deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.rollback-preparation.outputs.issue-number }},
              body: 'Deployment Completed Successfully\n\nRollback artifact details:\n- Previous Commit: ${{ env.PREVIOUS_SHA }}\n- Current Commit: ${{ github.sha }}\n- Package Version: ${{ env.PACKAGE_VERSION }}\n- Artifact: rollback-package-${{ env.PREVIOUS_SHA }}'
            });

      - name: Close deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.rollback-preparation.outputs.issue-number }},
              state: 'closed'
            });
